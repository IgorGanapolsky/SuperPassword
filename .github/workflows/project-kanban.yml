name: Project Kanban Management

on:
  issues:
    types: [opened, labeled, assigned, closed]
  pull_request:
    types: [opened, ready_for_review, closed]
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  auto-add-to-project:
    name: Auto-add to Project
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      (contains(github.event.issue.labels.*.name, 'priority:high') || 
       contains(github.event.issue.labels.*.name, 'priority:critical'))
    steps:
      - name: Add to project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/users/IgorGanapolsky/projects/1
          github-token: ${{ secrets.PROJECT_PAT }}

  move-card-when-issue-assigned:
    name: Move card when issue assigned
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'assigned' && 
      github.event.issue.assignee != null
    steps:
      - name: Move issue to In Progress
        uses: leonsteinhaeuser/project-beta-automations@v2.2.1
        with:
          gh_token: ${{ secrets.PROJECT_PAT }}
          organization: IgorGanapolsky
          project_id: 1
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: "In Progress"

  move-card-when-pr-ready:
    name: Move card when PR ready for review
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'ready_for_review'
    steps:
      - name: Move PR to Review
        uses: leonsteinhaeuser/project-beta-automations@v2.2.1
        with:
          gh_token: ${{ secrets.PROJECT_PAT }}
          organization: IgorGanapolsky
          project_id: 1
          resource_node_id: ${{ github.event.pull_request.node_id }}
          status_value: "Review"

  move-card-when-closed:
    name: Move card when issue/PR closed
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && github.event.action == 'closed') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    steps:
      - name: Move to Done
        uses: leonsteinhaeuser/project-beta-automations@v2.2.1
        with:
          gh_token: ${{ secrets.PROJECT_PAT }}
          organization: IgorGanapolsky
          project_id: 1
          resource_node_id: ${{ github.event.issue.node_id || github.event.pull_request.node_id }}
          status_value: "Done"
