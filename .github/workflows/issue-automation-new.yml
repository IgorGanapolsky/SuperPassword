name: Issue Automation

on:
  issues:
    types: [opened, edited, labeled, unlabeled]

permissions:
  issues: write
  contents: read
  repository-projects: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initial issue triage
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            // Add priority label if missing
            const hasPriority = issue.labels.some(label => 
              label.name.startsWith('priority:')
            );
            if (!hasPriority) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['priority: medium']
              });
            }

            // Add type label if missing
            const hasType = issue.labels.some(label => 
              label.name.startsWith('type:')
            );
            if (!hasType && !issue.title.includes('Project Status')) {
              const title = issue.title.toLowerCase();
              let typeLabel = 'type: feature';
              
              if (title.includes('fix:') || title.includes('bug')) {
                typeLabel = 'type: bug';
              } else if (title.includes('test:')) {
                typeLabel = 'type: test';
              }
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [typeLabel]
              });
            }

      - name: Add to project board
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            query($org: String!, $repo: String!) {
              repository(owner: $org, name: $repo) {
                projectsV2(first: 1) {
                  nodes {
                    id
                  }
                }
              }
            }' -f org=${{ github.repository_owner }} -f repo=${{ github.event.repository.name }} --jq '.data.repository.projectsV2.nodes[0].id')

          if [ ! -z "$PROJECT_ID" ]; then
            gh api graphql -f query='
              mutation($project:ID!, $issue:ID!) {
                addProjectV2ItemById(input: {projectId: $project, contentId: $issue}) {
                  item {
                    id
                  }
                }
              }' -f project="$PROJECT_ID" -f issue="${{ github.event.issue.node_id }}" --silent
          fi

      - name: Add analysis comment
        if: "!contains(github.event.issue.title, 'Project Status')"
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            
            const analysis = `
            ## Issue Analysis
            
            - Type: ${issue.labels.find(l => l.name.startsWith('type:'))?.name || 'Unclassified'}
            - Priority: ${issue.labels.find(l => l.name.startsWith('priority:'))?.name || 'Unassigned'}
            - Created: ${new Date(issue.created_at).toLocaleString()}
            
            ### Monitoring
            - [ ] Added to project board
            - [ ] Priority assigned
            - [ ] Labels verified
            
            I'll keep monitoring this issue for updates and SLA compliance.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: analysis
            });
