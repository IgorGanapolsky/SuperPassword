---
name: Project Sync (Deprecated)

on:
  workflow_dispatch:

jobs:
  noop:
    runs-on: ubuntu-latest
    steps:
      - run: echo "This workflow is deprecated. Status updates are handled by SuperPassword Main Pipeline."

on:
  issues:
    types: [opened, closed, reopened, assigned]
  pull_request:
    types: [opened, closed, reopened, ready_for_review]
  schedule:
    # Update status every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    steps:
      - name: Update Issue #81 with Project Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            console.log('Starting project status update...');
            
            try {
              // Get all open issues and PRs
              const [issues, prs] = await Promise.all([
                github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  per_page: 100
                }),
                github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  per_page: 100
                })
              ]);

              // Filter out PR issues and the status issue itself
              const actualIssues = issues.data.filter(issue => 
                !issue.pull_request && issue.number !== 81
              );

              // Calculate stats
              const stats = {
                openIssues: actualIssues.length,
                openPRs: prs.data.length,
                inProgress: actualIssues.filter(issue => 
                  issue.assignees.length > 0
                ).length,
                bugs: actualIssues.filter(issue => 
                  issue.labels.some(label => label.name.includes('bug'))
                ).length,
                features: actualIssues.filter(issue => 
                  issue.labels.some(label => label.name.includes('enhancement') || label.name.includes('feature'))
                ).length
              };

              // Get recent activity (last 7 days)
              const weekAgo = new Date();
              weekAgo.setDate(weekAgo.getDate() - 7);
              
              const recentActivity = actualIssues.filter(issue => 
                new Date(issue.updated_at) > weekAgo
              ).length;

              // Calculate health metrics
              const totalWork = stats.openIssues + stats.openPRs;
              const activeWork = stats.inProgress + stats.openPRs;
              const activityRate = totalWork > 0 ? Math.round((recentActivity / totalWork) * 100) : 0;
              const progressRate = stats.openIssues > 0 ? Math.round((stats.inProgress / stats.openIssues) * 100) : 0;

              const updateBody = `# ğŸ“Š SuperPassword Project Status

*Last updated: ${new Date().toLocaleString('en-US', { 
                timeZone: 'America/New_York', 
                dateStyle: 'full', 
                timeStyle: 'medium' 
              })}*

## ğŸ“ˆ Current Metrics

| Metric | Count | Status |
|--------|-------|--------|
| ğŸ“‹ Open Issues | ${stats.openIssues} | ${stats.openIssues > 10 ? 'ğŸ”´ High' : stats.openIssues > 5 ? 'ğŸŸ¡ Medium' : 'ğŸŸ¢ Good'} |
| ğŸ”§ Open PRs | ${stats.openPRs} | ${stats.openPRs > 5 ? 'ğŸ”´ High' : stats.openPRs > 2 ? 'ğŸŸ¡ Medium' : 'ğŸŸ¢ Good'} |
| ğŸƒ In Progress | ${stats.inProgress} | ${progressRate}% of issues |
| ğŸ› Bugs | ${stats.bugs} | ${stats.bugs > 5 ? 'ğŸ”´ Critical' : stats.bugs > 2 ? 'ğŸŸ¡ Moderate' : 'ğŸŸ¢ Low'} |
| âœ¨ Features | ${stats.features} | ${stats.features} planned |

## ğŸ¯ Health Dashboard

### Activity Level: ${activityRate >= 50 ? 'ğŸŸ¢ High' : activityRate >= 25 ? 'ğŸŸ¡ Moderate' : 'ğŸ”´ Low'}
- **Recent Activity**: ${recentActivity} items updated in the last 7 days
- **Activity Rate**: ${activityRate}% of items show recent activity

### Progress Health: ${progressRate >= 40 ? 'ğŸŸ¢ Good' : progressRate >= 20 ? 'ğŸŸ¡ Fair' : 'ğŸ”´ Needs Attention'}
- **Work in Progress**: ${progressRate}% of issues are actively assigned
- **Velocity**: ${stats.inProgress + stats.openPRs} items in active development

## ğŸ“‹ Issue Breakdown

\`\`\`
ğŸ“Š Distribution:
â”œâ”€â”€ ğŸ› Bugs: ${stats.bugs}
â”œâ”€â”€ âœ¨ Features: ${stats.features}
â””â”€â”€ ğŸ“ Other: ${stats.openIssues - stats.bugs - stats.features}
\`\`\`

## ğŸ¯ Recommendations

${stats.openIssues > 15 ? 'âš ï¸ **High Issue Count**: Consider prioritizing issue resolution\n' : ''}
${stats.bugs > 5 ? 'ğŸ› **Bug Alert**: Multiple bugs detected - prioritize bug fixes\n' : ''}
${progressRate < 30 ? 'ğŸ“ˆ **Low Progress Rate**: Consider assigning more issues to active development\n' : ''}
${activityRate < 25 ? 'ğŸ’¡ **Low Activity**: Project may need more regular updates\n' : ''}
${stats.openIssues <= 5 && stats.bugs <= 2 ? 'âœ… **Healthy Project**: Good balance of issues and activity\n' : ''}

## ğŸ”„ Automation Status

- âœ… Auto-labeling active
- âœ… Project board sync enabled
- âœ… Status updates every hour
- âœ… Manual updates available

---

*This status is automatically updated by GitHub Actions. For manual refresh, trigger the "Project Board Sync" workflow.*`;

              // Update the status issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: 81,
                body: updateBody
              });

              console.log('âœ… Successfully updated project status issue #81');
              console.log(`ğŸ“Š Stats: ${stats.openIssues} issues, ${stats.openPRs} PRs, ${stats.inProgress} in progress`);
              
            } catch (error) {
              console.error('âŒ Error updating project status:', error);
              throw error;
            }
